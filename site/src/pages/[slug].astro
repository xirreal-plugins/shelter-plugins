---
export const prerender = true;

import { getCollection } from "astro:content";
import RichHead from "../components/RichHead.astro";
import GitHub from "../components/GitHub.astro";
import BackIcon from "../components/BackIcon.astro";
import InfoBadge from "../components/InfoBadge.astro";
import CopyIcon from "../components/CopyIcon.astro";
import WarningBadge from "../components/WarningBadge.astro";

export async function getStaticPaths() {
   const plugins = await getCollection("plugins");
   return plugins.map((p) => ({ params: { slug: p.id } }));
}

const { slug } = Astro.params;
const plugins = await getCollection("plugins");
const plugin = plugins.find((p) => p.id === slug)!;

const username = "xirreal";
const profilePicUrl = `https://github.com/${username}.png`;
---

<!doctype html>
<html lang="en">
   <head>
      <RichHead title={`${plugin.data.title}`} description={plugin.data.description} image={plugin.data.demoImage} url={Astro.url} />
      <noscript>
         <style>
            .oneclick-install {
               display: none !important;
            }
         </style>
      </noscript>
   </head>
   <body class="p-8 bg-[#1b1026] text-gray-200 h-screen">
      <div
         class="p-4 pb-8 bg-[#372747] shadow-sm hover:shadow-md transition-shadow border border-[#51425e] rounded-2 flex flex-col items-center justify-start shadow-md max-w-3xl mx-auto"
      >
         <img src={profilePicUrl} alt={`${username}'s profile picture`} class="profile-image w-24 h-24 rounded-full mb-4 border-2 border-[#51425e]" />
         <h1 class="text-xl font-bold mb-2 text-center">{plugin.data.title}</h1>

         {
            plugin.data.demoImage && (
               <div class="flex-shrink-0 w-80% m-4">
                  <img src={plugin.data.demoImage} alt={`${plugin.data.title} example`} class="w-full h-auto rounded-2 object-cover" />
               </div>
            )
         }

         <div class="mt-2 w-full">
            {(<p class="text-gray-400 text-center leading-relaxed">{plugin.data.longDescription || plugin.data.description || "No description available."}</p>)}
         </div>

         <div class="mt-4 w-full">
            {
               plugin.data.warnings &&
                  plugin.data.warnings.length > 0 &&
                  plugin.data.warnings.map((w: string) => (
                     <div class="mx-auto w-full max-w-xl">
                        <WarningBadge message={w} />
                     </div>
                  ))
            }
            {
               plugin.data.infos &&
                  plugin.data.infos.length > 0 &&
                  plugin.data.infos.map((i: string) => (
                     <div class="mx-auto w-full max-w-xl">
                        <InfoBadge message={i} />
                     </div>
                  ))
            }
         </div>

         <br />

         <p class="mt-2 oneclick-install">OneClickâ„¢ install:</p>
         <a href="#" data-ws-install={plugin.data.url} class="inline-block m-2 cursor-pointer oneclick-install">
            <img src="/send.svg" alt={`One click installer for ${plugin.data.title}`} class="w-32 h-auto" />
         </a>
         <div class="mt-2 relative">
            <span>Manual installation:</span>
            <a
               onclick="document.copyToClipboard(this); return false;"
               class="text-[#9171ad] underline hover:text-[#bf96e3] break-all cursor-pointer"
               href={plugin.data.url}
            >
               {plugin.data.url}
               <CopyIcon />
            </a>
            <div class="absolute -bottom-10 bg-[#291c36] border-[#51425e] border-1 border-solid px-2 py-1 rounded-2 opacity-0 transition-opacity duration-300">
               Copied!
            </div>
         </div>

         <br />

         <div class="mt-6 text-center w-full">
            <a href="/" class="text-[#9171ad] underline hover:text-[#bf96e3] inline-flex items-center gap-2 justify-center">
               <BackIcon /> Back to plugins
            </a>
         </div>

         <div class="mt-4">
            <GitHub />
         </div>
      </div>

      <script>
         declare global {
            interface Document {
               copyToClipboard: (target: HTMLAnchorElement) => void;
            }
            interface HTMLElement {
               _copyTimeoutId?: number;
            }
         }

         document.copyToClipboard = (target: HTMLAnchorElement) => {
            const url = target.href;
            navigator.clipboard.writeText(url).then(() => {
               const tooltip = target.nextElementSibling as HTMLElement | null;
               const label = target.previousElementSibling as HTMLElement | null;
               if (tooltip && label) {
                  tooltip.style.left = `${label.getBoundingClientRect().width + target.getBoundingClientRect().width / 2 - tooltip.getBoundingClientRect().width / 2}px`;
                  tooltip.classList.remove("opacity-0");
               }
               if (target._copyTimeoutId !== undefined) {
                  clearTimeout(target._copyTimeoutId);
               }
               target._copyTimeoutId = setTimeout(() => {
                  tooltip?.classList.add("opacity-0");
               }, 750);
            });
         };

         document.querySelectorAll<HTMLAnchorElement>("[data-ws-install]").forEach((el) => {
            el.addEventListener("click", (e) => {
               e.preventDefault();
               const url = el.dataset.wsInstall;
               if (!url) return;
               const ws = new WebSocket("ws://127.0.0.1:6767");
               ws.onopen = () => {
                  ws.send(JSON.stringify({ type: "install", url }));
                  ws.close();
               };
               ws.onerror = () => {
                  alert("Could not connect to Discord. Make sure Discord is running and the Install Button plugin is enabled.");
               };
            });
         });
      </script>


   </body>
</html>
